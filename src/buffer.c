#include "buffer.h"

char gg_buffer_gs[512] = {
  /* R     G     B */
   0x01, 0x01, 0x01,
   0x00, 0x00, 0xFF,


   0x00, 0x00, 0x00,
   0xDD, 0xDD, 0xDD,
   0xCC, 0xCC, 0xCC,
   0xBB, 0xBB, 0xBB,
   0xAA, 0xAA, 0xAA,
   0x99, 0x99, 0x99,
   0x88, 0x88, 0x88,
   0x77, 0x77, 0x77,
   0x66, 0x66, 0x66,
   0x55, 0x55, 0x55,
   0x44, 0x44, 0x44,
   0x33, 0x33, 0x33,
   0x22, 0x22, 0x22,
   0x11, 0x11, 0x00,

   0x00, 0x00, 0xFF,



   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,
   0x00, 0x00, 0x00,



   0xFF, 0xFF, 0xFF,
   0xEE, 0xEE, 0xEE,
   0xDD, 0xDD, 0xDD,
   0xCC, 0xCC, 0xCC,
   0xBB, 0xBB, 0xBB,
   0xAA, 0xAA, 0xAA,
   0x99, 0x99, 0x99,
   0x88, 0x88, 0x88,
   0x77, 0x77, 0x77,
   0x66, 0x66, 0x66,
   0x55, 0x55, 0x55,
   0x44, 0x44, 0x44,
   0x33, 0x33, 0x33,
   0x22, 0x22, 0x22,
   0x11, 0x11, 0x11,
   0x01, 0x02, 0x03
};

char gg_buffer_dc[3]   = {
  0x0B, // R
  0x09, // G
  0x0A  // B
};


///////////////////////////////

#include "mcu.h"
#include "sched.h"
#include "tlc.h"

#include <string.h>

sched_res_t buffer_test_next(void);

void buffer_init(void)
{
  
  #define BUFFER_INIT_KEEP 0
  #if BUFFER_INIT_KEEP == 1
  memset(gg_buffer_gs, 0x00, sizeof(gg_buffer_gs));
  #endif
  for (uint8_t i = 0; i < (TLC_N_CHANNELS / TLC_N_TLCS_PER_PAINTER - BUFFER_INIT_KEEP); i++)
    for (uint8_t rgb = 0; rgb < 3; rgb++)
      gg_buffer_gs[i * 3 + rgb] = 0x10 | (rgb + 1);
}

void buffer_next(void)
{
  //sched_put(&buffer_test_next);
  buffer_test_next();
}


volatile uint8_t g_test_cnt;
sched_res_t buffer_test_next(void)
{
#if 0
  uint8_t rgb =  0;
  uint8_t cnt = -1;
  if (g_test_cnt++ != 100) return SCHED_RE;
  g_test_cnt = 0;

  gg_buffer_gs[rgb] += cnt;
  if (gg_buffer_gs[rgb] == 0) {
    rgb = (rgb + 1) % 3;
    if (rgb == 0) cnt *= -1;
  }
#endif
  tlc_set_data_done();
  return SCHED_OK;
}
